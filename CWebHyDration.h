
#ifndef CWEB_HYDRATION
#define CWEB_HYDRATION
const char * private_cweb_hydration_js_content = "\xa\xa\xa\x6c\x65\x74\x20\x70\x72\x69\x76\x61\x74\x65\x5f\x63\x77\x65\x62\x5f\x63\x61\x6c\x6c\x62\x61\x63\x6b\x73\x20\x3d\x20\x7b\x7d\xa\xa\x70\x72\x69\x76\x61\x74\x65\x5f\x63\x77\x65\x62\x5f\x63\x61\x6c\x6c\x62\x61\x63\x6b\x73\x2e\x70\x72\x69\x76\x61\x74\x65\x5f\x63\x77\x65\x62\x5f\x61\x6c\x65\x72\x74\x20\x3d\x20\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x28\x61\x72\x67\x73\x29\x7b\xa\x20\x20\x20\x20\x61\x6c\x65\x72\x74\x28\x61\x72\x67\x73\x2e\x6d\x65\x6e\x73\x73\x61\x67\x65\x29\x3b\xa\x7d\xa\xa\xa\x70\x72\x69\x76\x61\x74\x65\x5f\x63\x77\x65\x62\x5f\x63\x61\x6c\x6c\x62\x61\x63\x6b\x73\x2e\x70\x72\x69\x76\x61\x74\x65\x5f\x63\x77\x65\x62\x5f\x64\x65\x73\x74\x72\x6f\x79\x5f\x62\x79\x5f\x69\x64\x20\x3d\x20\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x28\x61\x72\x67\x73\x29\x7b\xa\x20\x20\x20\x20\x6c\x65\x74\x20\x65\x6c\x65\x6d\x65\x6e\x74\x20\x3d\x20\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x67\x65\x74\x45\x6c\x65\x6d\x65\x6e\x74\x42\x79\x49\x64\x28\x61\x72\x67\x73\x2e\x69\x64\x29\x3b\xa\x20\x20\x20\x20\x69\x66\x28\x65\x6c\x65\x6d\x65\x6e\x74\x29\x7b\xa\x20\x20\x20\x20\x20\x20\x20\x20\x65\x6c\x65\x6d\x65\x6e\x74\x2e\x72\x65\x6d\x6f\x76\x65\x28\x29\x3b\xa\x20\x20\x20\x20\x7d\xa\x7d\xa\xa\xa\xa\xa\x70\x72\x69\x76\x61\x74\x65\x5f\x63\x77\x65\x62\x5f\x63\x61\x6c\x6c\x62\x61\x63\x6b\x73\x2e\x70\x72\x69\x76\x61\x74\x65\x5f\x63\x77\x65\x62\x5f\x68\x79\x64\x72\x61\x74\x69\x6f\x6e\x5f\x72\x65\x70\x6c\x61\x63\x65\x5f\x62\x79\x5f\x69\x64\x20\x3d\x20\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x28\x61\x72\x67\x73\x29\x7b\xa\x20\x20\x20\x20\x6c\x65\x74\x20\x65\x6c\x65\x6d\x65\x6e\x74\x20\x3d\x20\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x67\x65\x74\x45\x6c\x65\x6d\x65\x6e\x74\x42\x79\x49\x64\x28\x61\x72\x67\x73\x2e\x69\x64\x29\x3b\xa\x20\x20\x20\x20\x69\x66\x28\x21\x65\x6c\x65\x6d\x65\x6e\x74\x29\x7b\xa\x20\x20\x20\x20\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6e\x20\x3b\xa\x20\x20\x20\x20\x7d\xa\x20\x20\x20\x20\x65\x6c\x65\x6d\x65\x6e\x74\x2e\x69\x6e\x73\x65\x72\x74\x41\x64\x6a\x61\x63\x65\x6e\x74\x48\x54\x4d\x4c\x28\x22\x61\x66\x74\x65\x72\x65\x6e\x64\x22\x2c\x61\x72\x67\x73\x2e\x68\x74\x6d\x6c\x29\x3b\xa\x20\x20\x20\x20\x65\x6c\x65\x6d\x65\x6e\x74\x2e\x72\x65\x6d\x6f\x76\x65\x28\x29\x3b\xa\x7d\xa\xa\xa\xa\xa\xa\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x70\x72\x69\x76\x61\x74\x65\x5f\x63\x77\x65\x62\x5f\x68\x79\x64\x72\x61\x74\x69\x6f\x6e\x5f\x67\x65\x74\x5f\x74\x65\x78\x74\x5f\x63\x6f\x6e\x74\x65\x6e\x74\x5f\x62\x79\x5f\x69\x64\x20\x28\x62\x6f\x64\x79\x2c\x69\x64\x29\x7b\xa\x20\x20\x20\x20\x6c\x65\x74\x20\x65\x6c\x65\x6d\x65\x6e\x74\x20\x3d\x20\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x67\x65\x74\x45\x6c\x65\x6d\x65\x6e\x74\x42\x79\x49\x64\x28\x69\x64\x29\x3b\xa\x20\x20\x20\x20\x69\x66\x28\x65\x6c\x65\x6d\x65\x6e\x74\x29\x7b\xa\x20\x20\x20\x20\x20\x20\x20\x20\x62\x6f\x64\x79\x5b\x69\x64\x5d\x20\x3d\x20\x65\x6c\x65\x6d\x65\x6e\x74\x2e\x74\x65\x78\x74\x43\x6f\x6e\x74\x65\x6e\x74\x2e\x74\x6f\x53\x74\x72\x69\x6e\x67\x28\x29\x3b\xa\x20\x20\x20\x20\x7d\xa\x7d\xa\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x70\x72\x69\x76\x61\x74\x65\x5f\x63\x77\x65\x62\x5f\x68\x79\x64\x72\x61\x74\x69\x6f\x6e\x5f\x6e\x75\x6d\x62\x65\x72\x5f\x67\x65\x74\x5f\x74\x65\x78\x74\x5f\x63\x6f\x6e\x74\x65\x6e\x74\x5f\x62\x79\x5f\x69\x64\x20\x28\x62\x6f\x64\x79\x2c\x69\x64\x29\x7b\xa\x20\x20\x20\x20\x6c\x65\x74\x20\x65\x6c\x65\x6d\x65\x6e\x74\x20\x3d\x20\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x67\x65\x74\x45\x6c\x65\x6d\x65\x6e\x74\x42\x79\x49\x64\x28\x69\x64\x29\x3b\xa\xa\x20\x20\x20\x20\x69\x66\x28\x65\x6c\x65\x6d\x65\x6e\x74\x29\x7b\xa\x20\x20\x20\x20\x20\x20\x20\x20\x62\x6f\x64\x79\x5b\x69\x64\x5d\x20\x3d\x20\x70\x61\x72\x73\x65\x46\x6c\x6f\x61\x74\x28\x65\x6c\x65\x6d\x65\x6e\x74\x2e\x74\x65\x78\x74\x43\x6f\x6e\x74\x65\x6e\x74\x2e\x74\x6f\x53\x74\x72\x69\x6e\x67\x28\x29\x29\x3b\xa\x20\x20\x20\x20\x7d\xa\x7d\xa\xa\xa\xa\xa\xa\x61\x73\x79\x6e\x63\x20\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x70\x72\x69\x76\x61\x74\x65\x5f\x63\x77\x65\x62\x5f\x73\x65\x6e\x64\x5f\x74\x6f\x5f\x73\x65\x72\x76\x65\x72\x28\x72\x6f\x75\x74\x65\x2c\x62\x6f\x64\x79\x29\x7b\xa\xa\x20\x20\x20\x20\x6c\x65\x74\x20\x72\x65\x73\x75\x6c\x74\x20\x3d\x20\x61\x77\x61\x69\x74\x20\x66\x65\x74\x63\x68\x28\x72\x6f\x75\x74\x65\x2c\x7b\xa\x20\x20\x20\x20\x20\x6d\x65\x74\x68\x6f\x64\x3a\x27\x50\x4f\x53\x54\x27\x2c\xa\x20\x20\x20\x20\x20\x62\x6f\x64\x79\x3a\x4a\x53\x4f\x4e\x2e\x73\x74\x72\x69\x6e\x67\x69\x66\x79\x28\x62\x6f\x64\x79\x29\xa\x20\x7d\x29\x3b\xa\x20\x69\x66\x28\x21\x72\x65\x73\x75\x6c\x74\x2e\x6f\x6b\x29\x7b\xa\x20\x20\x20\x20\x20\x63\x6f\x6e\x73\x6f\x6c\x65\x2e\x6c\x6f\x67\x28\x72\x65\x73\x75\x6c\x74\x2e\x74\x65\x78\x74\x28\x29\x29\x3b\xa\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6e\x3b\xa\x20\x7d\xa\x20\x6c\x65\x74\x20\x70\x61\x72\x73\x65\x64\x20\x3d\x61\x77\x61\x69\x74\x20\x72\x65\x73\x75\x6c\x74\x2e\x6a\x73\x6f\x6e\x28\x29\x3b\xa\x20\x70\x61\x72\x73\x65\x64\x2e\x66\x6f\x72\x45\x61\x63\x68\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x28\x63\x61\x6c\x6c\x62\x61\x63\x6b\x29\x7b\xa\x20\x20\x20\x20\x20\x74\x72\x79\x7b\xa\x20\x20\x20\x20\x20\x20\x20\x20\x20\x70\x72\x69\x76\x61\x74\x65\x5f\x63\x77\x65\x62\x5f\x63\x61\x6c\x6c\x62\x61\x63\x6b\x73\x5b\x63\x61\x6c\x6c\x62\x61\x63\x6b\x2e\x63\x61\x6c\x6c\x62\x61\x63\x6b\x5d\x28\x63\x61\x6c\x6c\x62\x61\x63\x6b\x2e\x61\x72\x67\x73\x29\xa\x20\x20\x20\x20\x20\x7d\xa\x20\x20\x20\x20\x20\x63\x61\x74\x63\x68\x20\x28\x65\x72\x72\x6f\x72\x29\x7b\xa\x20\x20\x20\x20\x20\x20\x20\x20\x20\x63\x6f\x6e\x73\x6f\x6c\x65\x2e\x6c\x6f\x67\x28\x65\x72\x72\x6f\x72\x29\x3b\xa\x20\x20\x20\x20\x20\x7d\xa\x20\x7d\x29\xa\x7d";


#define PRIVATE_CWEB_HYDRATION_GET_INPUT_BY_ID "private_cweb_hydration_get_input_by_id"

#define PRIVATE_CWEB_HYDRATION_GET_INPUT_CHECBOX_BY_ID "private_cweb_hydration_get_input_checkbox_by_id"

#define PRIVATE_CWEB_HYDRATION_GET_TEXT_CONTENT_BY_ID "private_cweb_hydration_get_text_content_by_id"

#define PRIVATE_CWEB_HYDRATION_GET_NUMBER_TEXT_CONTENT_BY_ID "private_cweb_hydration_number_get_text_content_by_id"

#define PRIVATE_CWEB_HYDRATION_GET_INPUT_BY_ALL_ID "private_cweb_hydration_get_input_by_all_id"

#define PRIVATE_CWEB_HYDRATION_GET_INPUT_CHECKBOX_BY_ALL_ID "private_cweb_hydration_get_input_checkbox_by_all_id"

#define PRIVATE_CWEB_HYDRATION_GET_TEXT_CONTENT_BY_ALL_ID "private_cweb_hydration_get_text_content_by_all_id"



#define PRIVATE_CWEB_HYDRATION_CALLBACK_KEY "callback"
#define PRIVATE_CWEB_HYDRATION_ARGS_KEY "args"
#define PRIVATE_CWEB_HYDRATION_ID_KEY "id"
#define PRIVATE_CWEB_HYDRATION_HTML_KEY "html"
#define PRIVATE_CWEB_HYDRATION_MENSSAGE_KEY "menssage"


#define PRIVATE_CWEB_HYDRATION_ALERT "private_cweb_alert"
#define PRIVATE_CWEB_HYDRATION_DESTROY_BY_ID "private_cweb_destroy_by_id"
#define PRIVATE_CWEB_HYDRATION_REPLACE_BY_ID "private_cweb_hydration_replace_by_id"

#define CWEB_HYDRATION_DEFAULT_BODY_SIZE 5000

#define CWEB_HYDRATION_NOT_BODY_JSON_PROVIDED 1
#define CWEB_HYDRATION_KEY_NOT_PROVIDED 2
#define CWEB_HYDRATION_KEY_WRONG_TYPE 3


#define CWEB_HYDRATION_NOT_BODY_JSON_PROVIDED_MSG "json body not provided"
#define CWEB_HYDRATION_KEY_NOT_PROVIDED_MSG  "json key %s not provided"
#define CWEB_HYDRATION_KEY_NOT_TYPE  "json key is not of type %s"

#define CWEB_HYDRATION_STRING "string"
#define CWEB_HYDRATION_BOOL  "bool"
#define CWEB_HYDRATION_NUMBER "number"






typedef struct  CWebHyDrationBridge {
    char *route;
    char *name;
    char *error;
    char *error_key;
    int error_type;
    CwebStringArray *callbacks;
    CwebStringArray *garbage;
    CwebHttpRequest *request;
    cJSON *response;
    int max_body_size;

    cJSON *body;
}CWebHyDrationBridge;






CWebHyDrationBridge *private_newCWebHyDrationBridge(
    const char *name,
    const char *route,
    CwebHttpRequest *request
    );



bool CWebHyDrationBridge_is_the_route(CWebHyDrationBridge *self);

char *CWebHyDrationBridge_call(CWebHyDrationBridge *self,char *func_args,...);

CTextStack *private_CWebHyDrationBridge_create_script(CWebHyDrationBridge *self);

void private_CWebHyDrationBridge_free(CWebHyDrationBridge *self);



void CWebHyDration_add_function(CWebHyDrationBridge *self,const char *function,const char *format, ...);

void CWebHyDration_add_input_by_id(CWebHyDrationBridge *self,const char *id);

void CWebHyDration_add_input_checkbox_by_id(CWebHyDrationBridge *self, const char *id);

void CWebHyDration_request_text_content_by_id(CWebHyDrationBridge *self, const char *id);

void CWebHyDration_request_number_text_content_by_id(CWebHyDrationBridge *self, const char *id);

void CWebHyDration_add_input_by_all_id(CWebHyDrationBridge *self, const char *id);

void CWebHyDration_add_input_checkbox_by_all_id(CWebHyDrationBridge *self, const char *id);

void CWebHyDration_request_text_content_by_all_id(CWebHyDrationBridge *self, const char *id);



void privateCWebHyDration_create_main_response(CWebHyDrationBridge *self);

void CWebHyDration_add_response_callback(CWebHyDrationBridge *self,const char *callback,cJSON *args);

void CWebHyDration_alert(CWebHyDrationBridge *self,const char *msg,...);

void CWebHyDration_destroy_by_id(CWebHyDrationBridge *self,const char *id);

void CWebHyDration_replace_element_by_id_with_ctext_stack_cleaning_memory(CWebHyDrationBridge *self,const char *id,CTextStack *stack);

CwebHttpResponse * CWebHyDration_generate_response(CWebHyDrationBridge *self);





int privateCWebHyDration_read_json(CWebHyDrationBridge *self);

const char * CWebHyDration_read_string(CWebHyDrationBridge *self,const char *name,...);

long CWebHyDration_read_long(CWebHyDrationBridge *self,const char *name,...);

double CWebHyDration_read_double(CWebHyDrationBridge *self,const char *name,...);

bool  CWebHyDration_read_bool(CWebHyDrationBridge *self,const char *name,...);

bool  CWebHyDration_exist(CWebHyDrationBridge *self,const char *name,...);



bool CWebHyDration_error(CWebHyDrationBridge *self);

const char * CWebHyDration_get_error_menssage(CWebHyDrationBridge *self);

const char * CWebHyDration_get_error_key(CWebHyDrationBridge *self);

int CWebHyDration_get_error_code(CWebHyDrationBridge *self);

CwebHttpResponse * CWebHyDration_generate_error_response(CWebHyDrationBridge *self);



typedef struct privateCWebHyDrationBridgeArray {
    CWebHyDrationBridge **elments;
    int size;

}privateCWebHyDrationBridgeArray;

privateCWebHyDrationBridgeArray * private_new_privateCWebHyDrationBridgeArray();

void privateCWebHyDrationBridgeArray_append(privateCWebHyDrationBridgeArray *self,CWebHyDrationBridge *element);

void privateCWebHyDrationBridgeArray_free(privateCWebHyDrationBridgeArray *self);





typedef struct CWebHyDration {
    CwebHttpRequest *request;
    CTextStack *script_text;
    privateCWebHyDrationBridgeArray *all_bridges;

}CWebHyDration;

CWebHyDration * newCWebHyDration(CwebHttpRequest *request);

CWebHyDrationBridge * CWebHyDration_create_bridge(CWebHyDration *self,const char *route,char *name);

char *CWebHyDration_create_script(CWebHyDration *self);

void CWebHyDration_free(CWebHyDration *self);





char * private_CWebHydration_format_vaarg(const char *expresion, va_list args);

char * private_CWebHydration_format(const char *expresion, ...);


typedef struct CWebHydrationNamespace{

    CWebHyDration *(*newHyDration)(CwebHttpRequest *request);
    //base
    CWebHyDrationBridge *(*create_bridge)(CWebHyDration *self,const char *route,char *name);
    char *(*create_script)(CWebHyDration *self);
    void (*free)(CWebHyDration *self);
    //bridge
    //basic
    bool(*is_the_route)(CWebHyDrationBridge *self);
    char *(*call)(CWebHyDrationBridge *self,char *func_args,...);

    //entries
    void (*add_function)(CWebHyDrationBridge *self,const char *function,const char *format, ...);
    void (*add_input_by_id)(CWebHyDrationBridge *self,const char *id);
    void (*add_input_checkbox_by_id)(CWebHyDrationBridge *self, const char *id);
    void (*request_text_content_by_id)(CWebHyDrationBridge *self, const char *id);
    void (*request_number_text_content_by_id)(CWebHyDrationBridge *self, const char *id);
    void (*add_input_by_all_id)(CWebHyDrationBridge *self, const char *id);
    void (*add_input_checkbox_by_all_id)(CWebHyDrationBridge *self, const char *id);
    void (*request_text_content_by_all_id)(CWebHyDrationBridge *self, const char *id);
    //read
    const char *(*read_string)(CWebHyDrationBridge *self,const char *name,...);
    long (*read_long)(CWebHyDrationBridge *self,const char *name,...);
    double (*read_double)(CWebHyDrationBridge *self,const char *name,...);
    bool (*read_bool)(CWebHyDrationBridge *self,const char *name,...);
    bool (*exist)(CWebHyDrationBridge *self,const char *name,...);
    //response
    void (*add_response_callback)(CWebHyDrationBridge *self,const char *callback,cJSON *args);
    void (*alert)(CWebHyDrationBridge *self,const char *msg,...);
    void (*destroy_by_id)(CWebHyDrationBridge *self,const char *id);
    void (*replace_element_by_id_with_ctext_stack_cleaning_memory)(CWebHyDrationBridge *self,const char *id,CTextStack *stack);
    CwebHttpResponse * (*generate_response)(CWebHyDrationBridge *self);


    bool (*error)(CWebHyDrationBridge *self);
    const char * (*get_error_menssage)(CWebHyDrationBridge *self);
    const char * (*get_error_key)(CWebHyDrationBridge *self);
    int (*get_error_code)(CWebHyDrationBridge *self);
    CwebHttpResponse * (*generate_error_response)(CWebHyDrationBridge *self);

}CWebHydrationNamespace;

CWebHydrationNamespace newCWebHydrationNamespace();




CWebHyDrationBridge *private_newCWebHyDrationBridge(
    const char *name,
    const char *route,
    CwebHttpRequest *request) {
    CWebHyDrationBridge *self = (CWebHyDrationBridge*)malloc(sizeof(CWebHyDrationBridge));
    *self = (CWebHyDrationBridge){0};
    if(name) {
        self->name = strdup(name);
    }
    self->route = strdup(route);
    self->request = request;
	self->callbacks = newCwebStringArray();
    self->garbage = newCwebStringArray();
    self->max_body_size = CWEB_HYDRATION_DEFAULT_BODY_SIZE;
    return  self;
}

bool   CWebHyDrationBridge_is_the_route(CWebHyDrationBridge *self) {
    return strcmp(self->route,self->request->route) == 0;
}

CTextStack *private_CWebHyDrationBridge_create_script(CWebHyDrationBridge *self) {
    CTextStack *function = newCTextStack_string_empty();
    CTextStack_format(function,"async function ");
    if(self->name) {
        CTextStack_format(function,"%s",self->name);
    }
    else {
        CTextStack *formatted_name = newCTextStack_string(self->route);
        CTextStack_self_replace(formatted_name,"/","");
        CTextStack_format(function,"%tc(args)",formatted_name);
    }
    CTextStack_format(function,"{\n");
    CTextStack_format(function,"\tlet body = {}\n");
    for(int i= 0; i < self->callbacks->size;i++) {
        CTextStack_format(function,"\t%s\n",self->callbacks->strings[i]);
    }

    CTextStack_format(function,"\tawait private_cweb_send_to_server('%s',body)\n",self->route);
    CTextStack_format(function,"}\n");
    return function;
}

char *CWebHyDrationBridge_call(CWebHyDrationBridge *self,char *func_args,...) {

    CTextStack *callback= newCTextStack_string_empty();

    if(self->name) {
        CTextStack_format(callback,"%s",self->name);
    }
    else {
        CTextStack *formatted_name = newCTextStack_string(self->route);
        CTextStack_self_replace(formatted_name,"/","");
        CTextStack_format(callback,"%tc",formatted_name);
    }

    if(func_args == NULL) {
        CTextStack_format(callback,"();");
        CwebStringArray_add(self->garbage,callback->rendered_text);
        CTextStack_free(callback);
        return self->garbage->strings[self->garbage->size-1];
    }

    va_list  args;
    va_start(args,func_args);
    char *result = private_CWebHydration_format_vaarg(func_args,args);
    va_end(args);
    CTextStack_format(callback,"(%sc);",result);
    CwebStringArray_add(self->garbage,callback->rendered_text);
    CTextStack_free(callback);
    return self->garbage->strings[self->garbage->size-1];

}
void private_CWebHyDrationBridge_free(CWebHyDrationBridge *self) {
    free(self->route);
    if(self->name) {
        free(self->name);
    }

    if(self->error) {
        free(self->error);
    }
    if(self->error_key) {
        free(self->error_key);
    }

    if(self->response) {
        cJSON_free(self->response);
    }
    CwebStringArray_free(self->callbacks);
    CwebStringArray_free(self->garbage);
    free(self);
}



void CWebHyDration_add_function(CWebHyDrationBridge *self,const char *function,const char *format, ...) {

    if(format == NULL) {
        CTextStack *code = newCTextStack_string_format("%s(body);",function);
        CwebStringArray_add(self->callbacks,code->rendered_text);
        CTextStack_free(code);
        return;
    }

    va_list  args;
    va_start(args,format);
    char *result = private_CWebHydration_format_vaarg(format,args);
    va_end(args);
    CTextStack *code = newCTextStack_string_format("%s(body,%s);",function,result);
    CwebStringArray_add(self->callbacks,code->rendered_text);
    CTextStack_free(code);
    free(result);
}

void CWebHyDration_add_input_by_id(CWebHyDrationBridge *self, const char *id) {

    CWebHyDration_add_function(self, PRIVATE_CWEB_HYDRATION_GET_INPUT_BY_ID, "'%s'", id);
}

void CWebHyDration_add_input_checkbox_by_id(CWebHyDrationBridge *self, const char *id){

    CWebHyDration_add_function(self, PRIVATE_CWEB_HYDRATION_GET_INPUT_CHECBOX_BY_ID ,"'%s'", id);
}

void CWebHyDration_request_text_content_by_id(CWebHyDrationBridge *self, const char *id){

    CWebHyDration_add_function(self, PRIVATE_CWEB_HYDRATION_GET_TEXT_CONTENT_BY_ID ,"'%s'", id);
}
void CWebHyDration_request_number_text_content_by_id(CWebHyDrationBridge *self, const char *id) {
    CWebHyDration_add_function(self, PRIVATE_CWEB_HYDRATION_GET_NUMBER_TEXT_CONTENT_BY_ID ,"'%s'", id);

}
void CWebHyDration_add_input_by_all_id(CWebHyDrationBridge *self, const char *id) {

    CWebHyDration_add_function(self, PRIVATE_CWEB_HYDRATION_GET_INPUT_BY_ALL_ID, "'%s'", id);
}

void CWebHyDration_add_input_checkbox_by_all_id(CWebHyDrationBridge *self, const char *id){

    CWebHyDration_add_function(self, PRIVATE_CWEB_HYDRATION_GET_INPUT_CHECKBOX_BY_ALL_ID, "'%s'", id);
}

void CWebHyDration_request_text_content_by_all_id(CWebHyDrationBridge *self, const char *id){

    CWebHyDration_add_function(self, PRIVATE_CWEB_HYDRATION_GET_TEXT_CONTENT_BY_ALL_ID ,"'%s'", id);
}




void privateCWebHyDration_create_main_response(CWebHyDrationBridge *self){
    if(self->response == NULL) {
        self->response = cJSON_CreateArray();
    }
}

void CWebHyDration_add_response_callback(CWebHyDrationBridge *self, const char *callback, cJSON *args) {
    privateCWebHyDration_create_main_response(self);
    cJSON *obj = cJSON_CreateObject();
    cJSON_AddItemToArray(self->response,obj);
    cJSON_AddStringToObject(obj,PRIVATE_CWEB_HYDRATION_CALLBACK_KEY,callback);
    cJSON_AddItemToObject(obj,PRIVATE_CWEB_HYDRATION_ARGS_KEY,args);

}

void CWebHyDration_alert(CWebHyDrationBridge *self,const char *msg,...) {
    cJSON *json_args = cJSON_CreateObject();
    va_list  args;
    va_start(args,msg);
    char *result = private_CWebHydration_format_vaarg(msg,args);
    va_end(args);
    cJSON_AddStringToObject(json_args,PRIVATE_CWEB_HYDRATION_MENSSAGE_KEY,result);
    CWebHyDration_add_response_callback(self,PRIVATE_CWEB_HYDRATION_ALERT,json_args);
    free(result);
}

void CWebHyDration_destroy_by_id(CWebHyDrationBridge *self,const char *id) {
    cJSON *json_args = cJSON_CreateObject();
    cJSON_AddStringToObject(json_args,PRIVATE_CWEB_HYDRATION_ID_KEY,id);
    CWebHyDration_add_response_callback(self,PRIVATE_CWEB_HYDRATION_DESTROY_BY_ID,json_args);
}

void CWebHyDration_replace_element_by_id_with_ctext_stack_cleaning_memory(CWebHyDrationBridge *self,const char *id,CTextStack *html) {
    cJSON *json_args = cJSON_CreateObject();
    cJSON_AddStringToObject(json_args,PRIVATE_CWEB_HYDRATION_ID_KEY,id);
    cJSON_AddStringToObject(json_args,PRIVATE_CWEB_HYDRATION_HTML_KEY,html->rendered_text);
    CWebHyDration_add_response_callback(self,PRIVATE_CWEB_HYDRATION_REPLACE_BY_ID,json_args);
    CTextStack_free(html);
}

CwebHttpResponse * CWebHyDration_generate_response(CWebHyDrationBridge *self) {
    return cweb_send_cJSON(self->response,200);
}



int privateCWebHyDration_read_json(CWebHyDrationBridge *self) {
     if(self->error != NULL){
          return -1;
     }
     if(self->body) {
          return 0;
     }
     self->body = CWebHttpRequest_read_cJSON(self->request,self->max_body_size);

     if(self->body == NULL) {
          self->error_type = CWEB_HYDRATION_NOT_BODY_JSON_PROVIDED;
          self->error = strdup(CWEB_HYDRATION_NOT_BODY_JSON_PROVIDED_MSG);
          return -1;
     }
     return 0;
}

#define privateCWebHydration_read(check_type,expected_type,retriver_value,error_return)\
if(privateCWebHyDration_read_json(self)) {\
     return error_return;\
}\
va_list  args;\
va_start(args,name);\
char *name_formmated = private_CWebHydration_format_vaarg(name,args);\
va_end(args);\
cJSON *element = cJSON_GetObjectItem(self->body,name_formmated);\
if(element == NULL) {\
     self->error_type = CWEB_HYDRATION_NOT_BODY_JSON_PROVIDED;\
     self->error = private_CWebHydration_format(CWEB_HYDRATION_KEY_NOT_PROVIDED_MSG,name_formmated);\
     self->error_key = strdup(name_formmated);\
     free(name_formmated);\
     return error_return;\
}\
\
if(!check_type(element)) {\
     self->error_type = CWEB_HYDRATION_KEY_WRONG_TYPE;\
     self->error = private_CWebHydration_format(CWEB_HYDRATION_KEY_NOT_TYPE,expected_type);\
     self->error_key = strdup(name_formmated);\
     free(name_formmated);\
     return error_return;\
}\
free(name_formmated);\
return retriver_value(element);

const char * CWebHyDration_read_string(CWebHyDrationBridge *self,const char *name,...) {
     privateCWebHydration_read(cJSON_IsString,CWEB_HYDRATION_STRING,cJSON_GetStringValue,NULL)
}



long CWebHyDration_read_long(CWebHyDrationBridge *self,const char *name,...) {
    privateCWebHydration_read(cJSON_IsNumber,CWEB_HYDRATION_NUMBER,(long)cJSON_GetNumberValue,-1)
}

double CWebHyDration_read_double(CWebHyDrationBridge *self,const char *name,...) {
     privateCWebHydration_read(cJSON_IsNumber,CWEB_HYDRATION_NUMBER,cJSON_GetNumberValue,-1)
}


bool  CWebHyDration_read_bool(CWebHyDrationBridge *self,const char *name,...) {
     privateCWebHydration_read(cJSON_IsNumber,CWEB_HYDRATION_NUMBER,(bool)cJSON_GetNumberValue,false)

}

bool  CWebHyDration_exist(CWebHyDrationBridge *self,const char *name,...) {
     if(privateCWebHyDration_read_json(self)) {
          return false;
     }
     va_list  args;
     va_start(args,name);
     char *name_formmated = private_CWebHydration_format_vaarg(name,args);
     va_end(args);
     cJSON *element = cJSON_GetObjectItem(self->body,name_formmated);
     if(element == NULL) {
          free(name_formmated);
          return false;
     }
     free(name_formmated);
     return true;
}






bool CWebHyDration_error(CWebHyDrationBridge *self) {
    if(self->error) {
        return  true;
    }
    return  false;
}

const char * CWebHyDration_get_error_menssage(CWebHyDrationBridge *self) {
    return  self->error;
}

const char * CWebHyDration_get_error_key(CWebHyDrationBridge *self) {
    return  self->error_key;
}

int CWebHyDration_get_error_code(CWebHyDrationBridge *self) {
    return  self->error_type;
}

CwebHttpResponse * CWebHyDration_generate_error_response(CWebHyDrationBridge *self) {
    if(self->error_type == CWEB_HYDRATION_NOT_BODY_JSON_PROVIDED || self->error_type == CWEB_HYDRATION_KEY_NOT_PROVIDED) {
        return cweb_send_text(self->error,404);
    }
    return cweb_send_text(self->error,400);
}




privateCWebHyDrationBridgeArray * private_new_privateCWebHyDrationBridgeArray() {
    privateCWebHyDrationBridgeArray *self = (privateCWebHyDrationBridgeArray*)malloc(sizeof(privateCWebHyDrationBridgeArray));
    *self = (privateCWebHyDrationBridgeArray){0};
    self->elments = (CWebHyDrationBridge**)malloc(0);
    return  self;
}

void privateCWebHyDrationBridgeArray_append(privateCWebHyDrationBridgeArray *self,CWebHyDrationBridge *element) {
    self->elments = (CWebHyDrationBridge**)realloc(
        self->elments,
        (self->size +1 )* sizeof(CWebHyDrationBridge*)
        );
    self->elments[self->size] =element;
    self->size+=1;
}

void privateCWebHyDrationBridgeArray_free(privateCWebHyDrationBridgeArray *self) {
    for(int i = 0; i  < self->size;i++) {
        private_CWebHyDrationBridge_free(self->elments[i]);
    }
    free(self->elments);
    free(self);
}






CWebHyDration * newCWebHyDration(CwebHttpRequest *request) {
    CWebHyDration *self = (CWebHyDration*)malloc(sizeof(CWebHyDration));
    *self = (CWebHyDration){0};
    self->all_bridges = private_new_privateCWebHyDrationBridgeArray();
    self->request =  request;
    return self;
}

CWebHyDrationBridge * CWebHyDration_create_bridge(CWebHyDration *self,const char *route,char *name) {
    CWebHyDrationBridge *created = private_newCWebHyDrationBridge(name,route,self->request);
    privateCWebHyDrationBridgeArray_append(self->all_bridges,created);
    return created;
}

char *CWebHyDration_create_script(CWebHyDration *self) {

    if(self->script_text) {
        CTextStack_free(self->script_text);
    }

    self->script_text = newCTextStack_string_empty();
    CTextStack_format(self->script_text,"%s",JS_CONTENT);

    for(int i =0; i < self->all_bridges->size;i++) {
        CWebHyDrationBridge *current = self->all_bridges->elments[i];
        CTextStack *created_code =private_CWebHyDrationBridge_create_script(current);
        CTextStack_format(self->script_text,"%tc",created_code);
    }
    return self->script_text->rendered_text;

}

void CWebHyDration_free(CWebHyDration *self) {
    if(self->script_text) {
        CTextStack_free(self->script_text);
    }
    privateCWebHyDrationBridgeArray_free(self->all_bridges);
    free(self);
}




char * private_CWebHydration_format_vaarg(const char *expresion, va_list args){

    va_list args_copy;
    va_copy(args_copy, args);
    long required_size = vsnprintf(NULL, 0,expresion,args_copy);
    va_end(args_copy);
    char *buffer = (char*)malloc(sizeof(char) * required_size + 2);
    vsnprintf(buffer,sizeof (char) * required_size+1,expresion,args);
    return buffer;
}
char * private_CWebHydration_format(const char *expresion, ...){
    va_list  args;
    va_start(args,expresion);
    char *result = private_CWebHydration_format_vaarg(expresion,args);
    va_end(args);
    return  result;
}



CWebHydrationNamespace newCWebHydrationNamespace() {
    CWebHydrationNamespace self = {0};
    //hidratation
    self.create_bridge = CWebHyDration_create_bridge;
    self.create_script = CWebHyDration_create_script;
    self.free = CWebHyDration_free;
    self.newHyDration = newCWebHyDration;
    //bridge
    //basic
    self.is_the_route = CWebHyDrationBridge_is_the_route;
    self.call = CWebHyDrationBridge_call;
    //entries
    self.add_function = CWebHyDration_add_function;
    self.add_input_by_id = CWebHyDration_add_input_by_id;
    self.add_input_checkbox_by_id = CWebHyDration_add_input_checkbox_by_id;
    self.request_text_content_by_id = CWebHyDration_request_text_content_by_id;
    self.request_number_text_content_by_id = CWebHyDration_request_number_text_content_by_id;

    self.add_input_by_all_id = CWebHyDration_add_input_by_all_id;
    self.add_input_checkbox_by_all_id = CWebHyDration_add_input_checkbox_by_all_id;
    self.request_text_content_by_all_id = CWebHyDration_request_text_content_by_all_id;
    //read
    self.read_string = CWebHyDration_read_string;
    self.read_long = CWebHyDration_read_long;
    self.read_double = CWebHyDration_read_double;
    self.read_bool = CWebHyDration_read_bool;
    self.exist = CWebHyDration_exist;
    //response
    self.add_response_callback = CWebHyDration_add_response_callback;
    self.alert = CWebHyDration_alert;
    self.destroy_by_id = CWebHyDration_destroy_by_id;
    self.replace_element_by_id_with_ctext_stack_cleaning_memory = CWebHyDration_replace_element_by_id_with_ctext_stack_cleaning_memory;
    self.generate_response = CWebHyDration_generate_response;
    //error
    self.error = CWebHyDration_error;
    self.get_error_menssage= CWebHyDration_get_error_menssage;
    self.get_error_key = CWebHyDration_get_error_key;
    self.get_error_code =CWebHyDration_get_error_code;
    self.generate_error_response = CWebHyDration_generate_error_response;

    return self;
}





#endif